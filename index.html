<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LifeDashboard v3.6</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      background: #f9f9f9;
    }
    h1 {
      margin-bottom: 0.5em;
    }
    p {
      margin-top: 0;
      margin-bottom: 2em;
    }
    .global-controls {
      margin-bottom: 1.5em;
    }
    .global-controls button {
      margin-right: 0.5em;
      padding: 0.5em 1em;
      cursor: pointer;
    }
    .filters {
      margin-bottom: 2em;
    }
    .filters input {
      padding: 0.5em;
      margin-right: 0.5em;
      width: 180px;
    }
    .section {
      background: #fff;
      padding: 1em;
      margin-bottom: 2em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
    }
    .section textarea {
      width: 300px;
      height: 60px;
      padding: 0.5em;
      font-size: 0.95em;
      resize: vertical;
      margin-bottom: 0.5em;
    }
    .section .tag-input {
      width: 300px;
      height: 28px;
      padding: 0.25em 0.5em;
      font-size: 0.85em;
      margin-bottom: 0.5em;
    }
    .section .buttons button {
      margin-right: 0.5em;
      padding: 0.5em 1em;
      cursor: pointer;
    }
    .history .entry {
      border-top: 1px solid #ddd;
      padding: 1em 0;
    }
    .entry .timestamp {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 0.5em;
    }
    .entry .tags span {
      background: #eef;
      color: #33c;
      padding: 0.2em 0.5em;
      margin-right: 0.3em;
      cursor: pointer;
      font-size: 0.85em;
    }
  </style>
</head>
<body>

  <h1>ğŸ§­ LifeDashboard v3.6</h1>
  <p>ã‚ãªãŸã®è¨˜æ†¶ã¨è¨˜éŒ²ã‚’ã¤ãªã’ã‚‹æ—¥è¨˜å‹ã‚¢ãƒ—ãƒª</p>

  <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«æ“ä½œ -->
  <div class="global-controls">
    <button onclick="saveAllEntries()">ä¸€æ‹¬ä¿å­˜</button>
    <button onclick="exportMarkdown()">MDä¿å­˜</button>
    <button onclick="exportJSON()">JSONä¿å­˜</button>
    <button onclick="document.getElementById('importFile').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <button onclick="clearAllEntries()">å…¨å‰Šé™¤</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importJSON(event)">
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filters">
    <input type="text" id="keywordFilter" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" oninput="filterAll()" />
    <input type="text" id="tagFilter" placeholder="ã‚¿ã‚°æ¤œç´¢ (#ãªã—)" oninput="filterAll()" />
    <button onclick="resetFilter()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <script>
    const sections = [
      { key: 'diary', title: 'ğŸ“˜ æ—¥è¨˜' },
      { key: 'study', title: 'ğŸ“š å‹‰å¼·' },
      { key: 'work',  title: 'ğŸ’¼ ä»•äº‹' },
      { key: 'plan',  title: 'ğŸ“… äºˆå®š' }
    ];
  </script>

  <div id="container"></div>

  <script>
    let data = {};

    window.onload = () => {
      initData();
      renderSections();
      loadAll();
    };

    function initData() {
      sections.forEach(s => {
        data[s.key] = JSON.parse(localStorage.getItem('life_' + s.key) || '[]');
      });
    }

    function renderSections() {
      const container = document.getElementById('container');
      sections.forEach(s => {
        const sec = document.createElement('div');
        sec.className = 'section';
        sec.id = s.key + 'Section';
        sec.innerHTML = `
          <h2>${s.title}</h2>
          <textarea id="${s.key}Input" placeholder="ã“ã“ã«æ›¸ã„ã¦ãã ã•ã„..."></textarea>
          <div>
            <input class="tag-input" id="${s.key}Tags" placeholder="ã‚¿ã‚°ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã£ã¦å…¥åŠ› (ä¾‹: åçœ èª­æ›¸)" />
          </div>
          <div class="buttons">
            <button onclick="saveEntry('${s.key}')">ä¿å­˜</button>
          </div>
          <div class="history" id="${s.key}History"></div>
        `;
        container.appendChild(sec);
      });
    }

    function loadAll() {
      sections.forEach(s => renderHistory(s.key));
    }

    function saveEntry(key) {
      const text = document.getElementById(key + 'Input').value.trim();
      if (!text) return;
      const tags = document.getElementById(key + 'Tags').value
        .split(/\s+/).filter(t => t);
      const entry = { text, tags, timestamp: new Date().toLocaleString() };
      data[key].unshift(entry);
      localStorage.setItem('life_' + key, JSON.stringify(data[key]));
      renderHistory(key);
      document.getElementById(key + 'Input').value = '';
      document.getElementById(key + 'Tags').value = '';
    }

    function saveAllEntries() {
      sections.forEach(s => {
        const txt = document.getElementById(s.key + 'Input').value.trim();
        if (txt) {
          const tags = document.getElementById(s.key + 'Tags').value
            .split(/\s+/).filter(t => t);
          const entry = { text: txt, tags, timestamp: new Date().toLocaleString() };
          data[s.key].unshift(entry);
          localStorage.setItem('life_' + s.key, JSON.stringify(data[s.key]));
          document.getElementById(s.key + 'Input').value = '';
          document.getElementById(s.key + 'Tags').value = '';
        }
        renderHistory(s.key);
      });
      alert('ã™ã¹ã¦ã®å…¥åŠ›ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function clearAllEntries() {
      if (!confirm('å…¨ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      sections.forEach(s => {
        data[s.key] = [];
        localStorage.removeItem('life_' + s.key);
        renderHistory(s.key);
        document.getElementById(s.key + 'Input').value = '';
        document.getElementById(s.key + 'Tags').value = '';
      });
    }

    function renderHistory(key) {
      const container = document.getElementById(key + 'History');
      container.innerHTML = '';
      const kw = document.getElementById('keywordFilter').value.trim();
      const tg = document.getElementById('tagFilter').value.trim();
      data[key].forEach(entry => {
        if (kw && !entry.text.includes(kw)) return;
        if (tg && !entry.tags.includes(tg)) return;
        const div = document.createElement('div');
        div.className = 'entry';
        const tagHtml = entry.tags
          .map(t => `<span onclick="setTagFilter('${t}')">${t}</span>`)
          .join('');
        div.innerHTML = `
          <div class="timestamp">${entry.timestamp}</div>
          <div class="tags">${tagHtml}</div>
          <div class="text">${entry.text}</div>
        `;
        container.appendChild(div);
      });
    }

    function filterAll() {
      sections.forEach(s => renderHistory(s.key));
    }

    function resetFilter() {
      document.getElementById('keywordFilter').value = '';
      document.getElementById('tagFilter').value = '';
      filterAll();
    }

    function setTagFilter(tag) {
      document.getElementById('tagFilter').value = tag;
      filterAll();
    }

    // -------------------------------
    // â† ã“ã“ã‹ã‚‰ä¸‹ã‚’ä¿®æ­£ã—ã¾ã—ãŸ
    // MD/JSON ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function download(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = filename;
      // Chrome ã‚„ Firefox ã§ç¢ºå®Ÿã«å‹•ãã‚ˆã†ã«ä¸€æ—¦ DOM ã«è¿½åŠ 
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // MD ä¿å­˜
    function exportMarkdown() {
      let md = `# LifeDashboard v3.6\n\n`;
      sections.forEach(s => {
        md += `## ${s.title}\n\n`;
        data[s.key].forEach(e => {
          const tags = e.tags.map(t => `#${t}`).join(' ');
          md += `**${e.timestamp}**  ${tags}\n\n${e.text}\n\n---\n\n`;
        });
      });
      download(md, 'lifeDashboard.md', 'text/markdown');
    }

    // JSON ä¿å­˜
    function exportJSON() {
      const json = JSON.stringify(data, null, 2);
      download(json, 'lifeDashboard.json', 'application/json');
    }

    // JSON ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importJSON(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          sections.forEach(s => {
            data[s.key] = obj[s.key] || [];
            localStorage.setItem('life_' + s.key, JSON.stringify(data[s.key]));
            renderHistory(s.key);
          });
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
        } catch {
          alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };
      reader.readAsText(file);
      evt.target.value = '';
    }
    // â†’ ä¿®æ­£ã“ã“ã¾ã§
  </script>

</body>
</html>
