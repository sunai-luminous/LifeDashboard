<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LifeDashboard v3.6</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      background: #f9f9f9;
    }
    h1 {
      margin-bottom: 0.5em;
    }
    p {
      margin-top: 0;
      margin-bottom: 2em;
    }
    .global-controls {
      margin-bottom: 1.5em;
    }
    .global-controls button {
      margin-right: 0.5em;
      padding: 0.5em 1em;
      cursor: pointer;
    }
    .filters {
      margin-bottom: 2em;
    }
    .filters input {
      padding: 0.5em;
      margin-right: 0.5em;
      width: 180px;
    }
    .section {
      background: #fff;
      padding: 1em;
      margin-bottom: 2em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
    }
    .section textarea {
      width: 300px;
      height: 60px;
      padding: 0.5em;
      font-size: 0.95em;
      resize: vertical;
      margin-bottom: 0.5em;
    }
    .section .tag-input {
      width: 300px;
      height: 28px;
      padding: 0.25em 0.5em;
      font-size: 0.85em;
      margin-bottom: 0.5em;
    }
    .section .buttons button {
      margin-right: 0.5em;
      padding: 0.5em 1em;
      cursor: pointer;
    }
    .history .entry {
      border-top: 1px solid #ddd;
      padding: 1em 0;
    }
    .entry .timestamp {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 0.5em;
    }
    .entry .tags span {
      background: #eef;
      color: #33c;
      padding: 0.2em 0.5em;
      margin-right: 0.3em;
      cursor: pointer;
      font-size: 0.85em;
    }
  </style>
</head>
<body>

  <h1>🧭 LifeDashboard v3.6</h1>
  <p>あなたの記憶と記録をつなげる日記型アプリ</p>

  <!-- グローバル操作 -->
  <div class="global-controls">
    <button onclick="saveAllEntries()">一括保存</button>
    <button onclick="exportMarkdown()">MD保存</button>
    <button onclick="exportJSON()">JSON保存</button>
    <button onclick="document.getElementById('importFile').click()">インポート</button>
    <button onclick="clearAllEntries()">全削除</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importJSON(event)">
  </div>

  <!-- フィルター -->
  <div class="filters">
    <input type="text" id="keywordFilter" placeholder="キーワード検索" oninput="filterAll()" />
    <input type="text" id="tagFilter" placeholder="タグ検索 (#なし)" oninput="filterAll()" />
    <button onclick="resetFilter()">リセット</button>
  </div>

  <script>
    const sections = [
      { key: 'diary', title: '📘 日記' },
      { key: 'study', title: '📚 勉強' },
      { key: 'work',  title: '💼 仕事' },
      { key: 'plan',  title: '📅 予定' }
    ];
  </script>

  <div id="container"></div>

  <script>
    let data = {};

    window.onload = () => {
      initData();
      renderSections();
      loadAll();
    };

    function initData() {
      sections.forEach(s => {
        data[s.key] = JSON.parse(localStorage.getItem('life_' + s.key) || '[]');
      });
    }

    function renderSections() {
      const container = document.getElementById('container');
      sections.forEach(s => {
        const sec = document.createElement('div');
        sec.className = 'section';
        sec.id = s.key + 'Section';
        sec.innerHTML = `
          <h2>${s.title}</h2>
          <textarea id="${s.key}Input" placeholder="ここに書いてください..."></textarea>
          <div>
            <input class="tag-input" id="${s.key}Tags" placeholder="タグをスペースで区切って入力 (例: 反省 読書)" />
          </div>
          <div class="buttons">
            <button onclick="saveEntry('${s.key}')">保存</button>
          </div>
          <div class="history" id="${s.key}History"></div>
        `;
        container.appendChild(sec);
      });
    }

    function loadAll() {
      sections.forEach(s => renderHistory(s.key));
    }

    function saveEntry(key) {
      const text = document.getElementById(key + 'Input').value.trim();
      if (!text) return;
      const tags = document.getElementById(key + 'Tags').value
        .split(/\s+/).filter(t => t);
      const entry = { text, tags, timestamp: new Date().toLocaleString() };
      data[key].unshift(entry);
      localStorage.setItem('life_' + key, JSON.stringify(data[key]));
      renderHistory(key);
      document.getElementById(key + 'Input').value = '';
      document.getElementById(key + 'Tags').value = '';
    }

    function saveAllEntries() {
      sections.forEach(s => {
        const txt = document.getElementById(s.key + 'Input').value.trim();
        if (txt) {
          const tags = document.getElementById(s.key + 'Tags').value
            .split(/\s+/).filter(t => t);
          const entry = { text: txt, tags, timestamp: new Date().toLocaleString() };
          data[s.key].unshift(entry);
          localStorage.setItem('life_' + s.key, JSON.stringify(data[s.key]));
          document.getElementById(s.key + 'Input').value = '';
          document.getElementById(s.key + 'Tags').value = '';
        }
        renderHistory(s.key);
      });
      alert('すべての入力を保存しました');
    }

    function clearAllEntries() {
      if (!confirm('全ての記録を削除しますか？')) return;
      sections.forEach(s => {
        data[s.key] = [];
        localStorage.removeItem('life_' + s.key);
        renderHistory(s.key);
        document.getElementById(s.key + 'Input').value = '';
        document.getElementById(s.key + 'Tags').value = '';
      });
    }

    function renderHistory(key) {
      const container = document.getElementById(key + 'History');
      container.innerHTML = '';
      const kw = document.getElementById('keywordFilter').value.trim();
      const tg = document.getElementById('tagFilter').value.trim();
      data[key].forEach(entry => {
        if (kw && !entry.text.includes(kw)) return;
        if (tg && !entry.tags.includes(tg)) return;
        const div = document.createElement('div');
        div.className = 'entry';
        const tagHtml = entry.tags
          .map(t => `<span onclick="setTagFilter('${t}')">${t}</span>`)
          .join('');
        div.innerHTML = `
          <div class="timestamp">${entry.timestamp}</div>
          <div class="tags">${tagHtml}</div>
          <div class="text">${entry.text}</div>
        `;
        container.appendChild(div);
      });
    }

    function filterAll() {
      sections.forEach(s => renderHistory(s.key));
    }

    function resetFilter() {
      document.getElementById('keywordFilter').value = '';
      document.getElementById('tagFilter').value = '';
      filterAll();
    }

    function setTagFilter(tag) {
      document.getElementById('tagFilter').value = tag;
      filterAll();
    }

    // -------------------------------
    // ← ここから下を修正しました
    // MD/JSON ダウンロードユーティリティ
    function download(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = filename;
      // Chrome や Firefox で確実に動くように一旦 DOM に追加
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // MD 保存
    function exportMarkdown() {
      let md = `# LifeDashboard v3.6\n\n`;
      sections.forEach(s => {
        md += `## ${s.title}\n\n`;
        data[s.key].forEach(e => {
          const tags = e.tags.map(t => `#${t}`).join(' ');
          md += `**${e.timestamp}**  ${tags}\n\n${e.text}\n\n---\n\n`;
        });
      });
      download(md, 'lifeDashboard.md', 'text/markdown');
    }

    // JSON 保存
    function exportJSON() {
      const json = JSON.stringify(data, null, 2);
      download(json, 'lifeDashboard.json', 'application/json');
    }

    // JSON インポート
    function importJSON(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          sections.forEach(s => {
            data[s.key] = obj[s.key] || [];
            localStorage.setItem('life_' + s.key, JSON.stringify(data[s.key]));
            renderHistory(s.key);
          });
          alert('インポートが完了しました');
        } catch {
          alert('JSONの読み込みに失敗しました');
        }
      };
      reader.readAsText(file);
      evt.target.value = '';
    }
    // → 修正ここまで
  </script>

</body>
</html>
