<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LifeDashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg: #f5f7fa;
      --fg: #2d3748;
      --muted: #718096;
      --border: #e2e8f0;
      --accent: #4299e1;
      --accent-red: #f56565;
    }
    [data-theme="dark"] {
      --bg: #1a202c;
      --fg: #e2e8f0;
      --muted: #cbd5e0;
      --border: #4a5568;
      --accent: #63b3ed;
      --accent-red: #fc8181;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background: var(--bg);
      color: var(--fg);
      transition: background .3s,color .3s;
      line-height: 1.5;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 16px;
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    .header p {
      color: var(--muted);
      font-size: .9rem;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .controls input {
      flex: 1;
      min-width: 120px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--fg);
      transition: border .2s;
    }
    .controls input:focus {
      border-color: var(--accent);
    }
    .controls button {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--fg);
      cursor: pointer;
      transition: background .2s, border .2s;
    }
    .controls button:hover {
      border-color: var(--accent);
    }
    .theme-toggle { font-weight: 600; }
    .data-management {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }
    .data-management button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: background .2s;
    }
    .data-management button:hover {
      background: var(--accent-red);
    }
    .data-management .btn-delete-all {
      background: var(--accent-red);
    }
    .data-management .btn-delete-all:hover {
      background: #e53e3e;
    }
    section {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }
    section h2 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-icon {
      width: 28px; height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent);
      color: #fff;
    }
    .section-delete {
      padding: 4px 8px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      background: var(--accent-red);
      color: #fff;
      cursor: pointer;
      transition: background .2s;
    }
    .section-delete:hover {
      background: #e53e3e;
    }
    textarea, .tag-input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      color: var(--fg);
      resize: vertical;
      margin-bottom: 8px;
    }
    .btn-save {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    .btn-save:hover {
      background: var(--accent-red);
    }
    .history {
      list-style: none;
      margin-top: 12px;
    }
    .history li {
      border-top: 1px solid var(--border);
      padding: 8px 0;
    }
    .timestamp {
      font-size: .8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .badge {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      padding: 2px 6px;
      font-size: .75rem;
      border-radius: 4px;
      margin-right: 4px;
    }
    .entry-content {
      white-space: pre-wrap;
      margin-top: 4px;
    }
    .toast {
      position: fixed;
      bottom: 20px; right: 20px;
      padding: 8px 16px;
      background: var(--accent);
      color: #fff;
      border-radius: 4px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity .3s, transform .3s;
      pointer-events: none;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body data-theme="light">
  <div class="container">
    <div class="header">
      <h1>📋 LifeDashboard</h1>
      <p>📅 <span id="current-date"></span></p>
    </div>

    <div class="controls">
      <input id="search-input" placeholder="🔍 キーワード">
      <input id="tag-input"    placeholder="🏷️ タグ絞込">
      <button class="theme-toggle" id="toggle-theme">🌙 ダーク</button>
    </div>

    <div class="data-management">
      <button id="export-all">💾 エクスポート</button>
      <button id="import-all">📥 インポート</button>
      <button id="delete-all" class="btn-delete-all">🗑️ 全削除</button>
    </div>

    <input type="file" id="file-input" accept=".md,.txt" style="display:none">

    <section id="diary">
      <h2>
        <span class="section-title">
          <span class="section-icon">📖</span>日記
        </span>
        <button class="section-delete" data-section="diary">削除</button>
      </h2>
      <textarea id="diary-input" rows="3" placeholder="今日の出来事…"></textarea>
      <input class="tag-input" id="diary-tags" placeholder="タグ (例: 重要, 楽しい)">
      <button class="btn-save" data-section="diary">保存</button>
      <ul class="history" id="diary-history"></ul>
    </section>

    <section id="study">
      <h2>
        <span class="section-title">
          <span class="section-icon">📚</span>勉強
        </span>
        <button class="section-delete" data-section="study">削除</button>
      </h2>
      <textarea id="study-input" rows="3" placeholder="学んだこと…"></textarea>
      <input class="tag-input" id="study-tags" placeholder="タグ (例: 数学, 英語)">
      <button class="btn-save" data-section="study">保存</button>
      <ul class="history" id="study-history"></ul>
    </section>

    <section id="work">
      <h2>
        <span class="section-title">
          <span class="section-icon">💼</span>仕事
        </span>
        <button class="section-delete" data-section="work">削除</button>
      </h2>
      <textarea id="work-input" rows="3" placeholder="仕事の記録…"></textarea>
      <input class="tag-input" id="work-tags" placeholder="タグ (例: 会議, タスク)">
      <button class="btn-save" data-section="work">保存</button>
      <ul class="history" id="work-history"></ul>
    </section>

    <section id="schedule">
      <h2>
        <span class="section-title">
          <span class="section-icon">📅</span>スケジュール
        </span>
        <button class="section-delete" data-section="schedule">削除</button>
      </h2>
      <textarea id="schedule-input" rows="3" placeholder="予定…"></textarea>
      <input class="tag-input" id="schedule-tags" placeholder="タグ (例: 締切, イベント)">
      <button class="btn-save" data-section="schedule">保存</button>
      <ul class="history" id="schedule-history"></ul>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      init();
    });

    function init() {
      updateDate();
      restoreTheme();
      bindControls();
      loadAllSections();
    }

    function updateDate() {
      const now = new Date();
      document.getElementById('current-date').textContent =
        now.toLocaleDateString('ja-JP', {
          year:'numeric',month:'long',day:'numeric',weekday:'long'
        });
    }

    function restoreTheme() {
      const btn = document.getElementById('toggle-theme');
      const theme = localStorage.getItem('theme') || 'light';
      document.body.dataset.theme = theme;
      btn.textContent = theme === 'light' ? '🌙 ダーク' : '☀️ ライト';
    }

    function toggleTheme() {
      const body = document.body;
      const next = body.dataset.theme === 'light' ? 'dark' : 'light';
      body.dataset.theme = next;
      localStorage.setItem('theme', next);
      document.getElementById('toggle-theme').textContent =
        next === 'light' ? '🌙 ダーク' : '☀️ ライト';
      showToast('テーマを切り替えました');
    }

    function bindControls() {
      document.getElementById('toggle-theme')
        .addEventListener('click', toggleTheme);

      document.querySelectorAll('.btn-save').forEach(btn => {
        btn.addEventListener('click', () => {
          saveEntry(btn.dataset.section);
        });
      });

      document.querySelectorAll('.section-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          deleteSection(btn.dataset.section);
        });
      });

      document.getElementById('export-all')
        .addEventListener('click', exportAll);

      document.getElementById('import-all')
        .addEventListener('click', () => {
          document.getElementById('file-input').click();
        });

      document.getElementById('delete-all')
        .addEventListener('click', deleteAllSections);

      document.getElementById('file-input')
        .addEventListener('change', handleImport);
    }

    function saveEntry(section) {
      const txtEl  = document.getElementById(`${section}-input`);
      const tagEl  = document.getElementById(`${section}-tags`);
      const txt    = txtEl.value.trim();
      if (!txt) return showToast('内容を入力してください','error');

      const now    = new Date();
      const header = `### ${now.toLocaleDateString('ja-JP',{month:'numeric',day:'numeric',weekday:'short'})} ${now.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}\n`;
      const tags   = tagEl.value
        .split(',').map(t=>t.trim()).filter(t=>t);
      const tagLn  = tags.length ? `タグ: ${tags.map(t=>`#${t}`).join(' ')}\n` : '';
      const entry  = header + tagLn + txt + '\n\n';

      const key    = `${section}-md`;
      const prev   = localStorage.getItem(key) || '';
      localStorage.setItem(key, entry + prev);

      txtEl.value = '';
      tagEl.value = '';
      renderHistory(section);
      showToast('保存しました！');
    }

    function deleteSection(section) {
      const sectionNames = {
        diary: '日記',
        study: '勉強', 
        work: '仕事',
        schedule: 'スケジュール'
      };
      
      if (confirm(`${sectionNames[section]}の履歴をすべて削除しますか？この操作は取り消せません。`)) {
        localStorage.removeItem(`${section}-md`);
        renderHistory(section);
        showToast(`${sectionNames[section]}を削除しました`);
      }
    }

    function deleteAllSections() {
      if (confirm('すべてのデータを削除しますか？この操作は取り消せません。')) {
        ['diary', 'study', 'work', 'schedule'].forEach(section => {
          localStorage.removeItem(`${section}-md`);
        });
        loadAllSections();
        showToast('すべてのデータを削除しました');
      }
    }

    function renderHistory(section) {
      const key = `${section}-md`;
      const md  = localStorage.getItem(key) || '';
      const ul  = document.getElementById(`${section}-history`);
      if (!md.trim()) {
        ul.innerHTML = '<li class="timestamp empty-state">まだ記録がありません</li>';
        return;
      }
      const blocks = md.trim().split('\n### ').map((b,i)=> i===0? b : '### '+b);
      ul.innerHTML = blocks.map(block => {
        const lines = block.split('\n');
        const ts    = lines[0].replace(/^###\s*/,'');
        let idx = 1, tags = [];
        if (lines[1].startsWith('タグ:')) {
          tags = lines[1].replace(/^タグ:\s*/,'').split(' ').map(t=>t.replace('#',''));
          idx = 2;
        }
        const content = lines.slice(idx).join('\n');
        const badges  = tags.map(t=>`<span class="badge">${t}</span>`).join('');
        return `
          <li>
            <div class="timestamp">${ts}</div>
            ${badges? `<div>${badges}</div>` : ''}
            <div class="entry-content">${escapeHtml(content)}</div>
          </li>`;
      }).join('');
    }

    function loadAllSections() {
      ['diary','study','work','schedule'].forEach(renderHistory);
    }

    function exportAll() {
      const now   = new Date();
      let md      = `# LifeDashboard - ${now.getFullYear()}年${now.toLocaleDateString('ja-JP',{month:'long'})}\n\n`;
      ['diary','study','work','schedule'].forEach(sec => {
        const data = localStorage.getItem(`${sec}-md`) || '';
        if (!data.trim()) return;
        const title = document.querySelector(`#${sec} h2 .section-title`).innerText;
        md += `## ${title}\n\n` + data;
      });
      const blob  = new Blob([md], { type:'text/markdown' });
      const url   = URL.createObjectURL(blob);
      const a     = document.createElement('a');
      a.href      = url;
      a.download  = `LifeDashboard-${now.toISOString().split('T')[0]}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('エクスポート完了！');
    }

    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const text = ev.target.result;
        const imp  = parseImportedMarkdown(text);
        if (confirm('既存に追加しますか？キャンセルで上書き')) {
          Object.keys(imp).forEach(sec => {
            const prev = localStorage.getItem(`${sec}-md`) || '';
            localStorage.setItem(`${sec}-md`, imp[sec] + prev);
          });
        } else {
          Object.keys(imp).forEach(sec => {
            localStorage.setItem(`${sec}-md`, imp[sec]);
          });
        }
        loadAllSections();
        showToast('インポート完了！');
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    function parseImportedMarkdown(md) {
      const map = { '日記':'diary','勉強':'study','仕事':'work','スケジュール':'schedule' };
      const lines = md.split('\n');
      let cur = null, buf = '';
      const out = { diary:'', study:'', work:'', schedule:'' };
      for (let line of lines) {
        if (line.startsWith('## ')) {
          if (cur && buf) {
            out[cur] += buf + '\n';
          }
          buf = '';
          const title = line.replace('## ','').trim();
          cur = map[title] || null;
        } else if (cur) {
          buf += line + '\n';
        }
      }
      if (cur && buf) out[cur] += buf;
      return out;
    }

    function showToast(msg, type='info') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.background = type==='error'? 'var(--accent-red)' : 'var(--accent)';
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }
  </script>
</body>
</html>
